

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reprogram the Stack: Make It Yours. &mdash; Motion-Stack 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=2709fde1"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="easy_robot_control package" href="easy_robot_control.html" />
    <link rel="prev" title="How to use your URDF with this repo" href="URDF_use.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Motion-Stack
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Motion stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="design_principles.html">URDF parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="design_principles.html#design-and-code-principles">Design and Code Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="design_principles.html#deprecated">Deprecated</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html#old">OLD</a></li>
<li class="toctree-l1"><a class="reference internal" href="use.html">How to use</a></li>
<li class="toctree-l1"><a class="reference internal" href="URDF_use.html">How to use your URDF with this repo</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Reprogram the Stack: Make It Yours.</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup-a-new-package">Setup a new package</a></li>
<li class="toctree-l2"><a class="reference internal" href="#launch-modification">Launch modification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#changing-params">Changing params</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changing-end-effector-and-leg-numbers">Changing end effector and leg numbers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overloading-to-have-a-single-robot-state-publisher">Overloading to have a single robot_state_publisher</a></li>
<li class="toctree-l3"><a class="reference internal" href="#remapping">Remapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#automating-modularity">Automating modularity</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loading-you-own-node">Loading you own node</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#changing-behavior">Changing behavior</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overloading">Overloading</a></li>
<li class="toctree-l3"><a class="reference internal" href="#injection">Injection</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="easy_robot_control.html">easy_robot_control package</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">moonbot_zero_tuto</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Motion-Stack</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Reprogram the Stack: Make It Yours.</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/API_for_DIY.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="reprogram-the-stack-make-it-yours">
<h1>Reprogram the Stack: Make It Yours.<a class="headerlink" href="#reprogram-the-stack-make-it-yours" title="Link to this heading"></a></h1>
<p>I encourage you to dive into the source code and customize it to fit
your robot’s unique needs. By importing the motion stack into your own
package, you can keep your customizations separate from the core motion
stack. This separation ensures that updates to either the motion stack
or your code won’t interfere with each other.</p>
<p>In this section, I’ll walk you through an example: creating a package to
launch the Moonbot Zero with a different configuration while modifying
the behavior of the motion stack’s nodes.</p>
<section id="setup-a-new-package">
<h2>Setup a new package<a class="headerlink" href="#setup-a-new-package" title="Link to this heading"></a></h2>
<p>Source ros2 before all those commands</p>
<p>Go in your workspace’s source:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/Moonbot-Motion-Stack/src/
</pre></div>
</div>
<p>Create a package with a node named lvl1:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>pkg<span class="w"> </span>create<span class="w"> </span>--build-type<span class="w"> </span>ament_python<span class="w"> </span>--node-name<span class="w"> </span>lvl1<span class="w"> </span>moonbot_zero
<span class="nb">cd</span><span class="w"> </span>moonbot_zero
</pre></div>
</div>
<p>Open <code class="docutils literal notranslate"><span class="pre">src/moonbot_zero/setup.py</span></code> and change it like below. This will
make all your .launch.py files in <code class="docutils literal notranslate"><span class="pre">launch/</span></code> available in the share
folder of the package so ros2 can find them</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">find_packages</span><span class="p">,</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span> <span class="c1"># add this line</span>

<span class="n">package_name</span> <span class="o">=</span> <span class="s1">&#39;moonbot_zero&#39;</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="n">package_name</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s1">&#39;0.0.0&#39;</span><span class="p">,</span>
    <span class="n">packages</span><span class="o">=</span><span class="n">find_packages</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]),</span>
    <span class="n">data_files</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;share/</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">/launch&quot;</span><span class="p">,</span> <span class="n">glob</span><span class="p">(</span><span class="s2">&quot;launch/*.launch.py&quot;</span><span class="p">)),</span> <span class="c1"># add this line</span>
        <span class="p">(</span><span class="s1">&#39;share/ament_index/resource_index/packages&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;resource/&#39;</span> <span class="o">+</span> <span class="n">package_name</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;share/&#39;</span> <span class="o">+</span> <span class="n">package_name</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;package.xml&#39;</span><span class="p">]),</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Create your own launcher in <code class="docutils literal notranslate"><span class="pre">launch/</span></code> of your new package:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/Moonbot-Motion-Stack/src/moonbot_zero
mkdir<span class="w"> </span>launch
<span class="nb">cd</span><span class="w"> </span>launch
touch<span class="w"> </span>myrobot.launch.py
</pre></div>
</div>
<p>Change <code class="docutils literal notranslate"><span class="pre">~/Moonbot-Motion-Stack/launch_stack.bash</span></code> like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ROS2_MOONBOT_WS</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>No<span class="w"> </span>folder<span class="w"> </span>shortcut,<span class="w"> </span>working<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$PWD</span>
.<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ROS2_INSTALL_PATH</span><span class="si">}</span><span class="s2">&quot;</span>/setup.bash<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>/opt/ros/humble/setup.bash<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>/opt/ros/foxy/setup.bash<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>Ros2<span class="w"> </span>not<span class="w"> </span>found<span class="w"> </span><span class="k">for</span><span class="w"> </span>auto-sourcing,<span class="w"> </span>continuing
<span class="nb">export</span><span class="w"> </span><span class="nv">RCUTILS_COLORIZED_OUTPUT</span><span class="o">=</span><span class="m">1</span>
colcon<span class="w"> </span>build<span class="w"> </span>--cmake-args<span class="w"> </span>-Wno-dev
.<span class="w"> </span>install/setup.bash
<span class="nb">export</span><span class="w"> </span><span class="nv">RCUTILS_CONSOLE_OUTPUT_FORMAT</span><span class="o">=</span><span class="s2">&quot;{message}&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NUMBA_CACHE_DIR</span><span class="o">=</span><span class="s2">&quot;./numba_cache&quot;</span><span class="w"> </span><span class="c1"># this will compile numba in a permanant file</span>

ros2<span class="w"> </span>launch<span class="w"> </span>moonbot_zero<span class="w"> </span>myrobot.launch.py<span class="w"> </span>MS_up_to_level:<span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="c1"># changed line</span>
</pre></div>
</div>
</section>
<section id="launch-modification">
<h2>Launch modification<a class="headerlink" href="#launch-modification" title="Link to this heading"></a></h2>
<p>Right now, with the default launch there is one robot_state_publisher
per leg. That’s a bit much. So let’s make it one for the whole robot.</p>
<p>Let’s also make the movement time longer, change leg numbers and remap a
few topics.</p>
<p>Edit your <code class="docutils literal notranslate"><span class="pre">myrobot.launch.py</span></code> and let us start with the default launch
provided by the motion stack:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">easy_robot_control.launch.builder</span> <span class="kn">import</span> <span class="n">LevelBuilder</span>


<span class="n">ROBOT_NAME</span> <span class="o">=</span> <span class="s2">&quot;moonbot_7&quot;</span>  <span class="c1"># name of the xacro to load</span>

<span class="n">LEGS_DIC</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;end1&quot;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;end2&quot;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;end3&quot;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;end4&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">lvl_builder</span> <span class="o">=</span> <span class="n">LevelBuilder</span><span class="p">(</span><span class="n">robot_name</span><span class="o">=</span><span class="n">ROBOT_NAME</span><span class="p">,</span> <span class="n">leg_dict</span><span class="o">=</span><span class="n">LEGS_DIC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">lvl_builder</span><span class="o">.</span><span class="n">make_description</span><span class="p">()</span>
</pre></div>
</div>
<p>You should be able to launch it (do this to see the effects of your
changes):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash<span class="w"> </span>launch_stack.bash
</pre></div>
</div>
<section id="changing-params">
<h3>Changing params<a class="headerlink" href="#changing-params" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="n">new_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;std_movement_time&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">lvl_builder</span> <span class="o">=</span> <span class="n">LevelBuilder</span><span class="p">(</span>
    <span class="n">robot_name</span><span class="o">=</span><span class="n">ROBOT_NAME</span><span class="p">,</span> <span class="n">leg_dict</span><span class="o">=</span><span class="n">LEGS_DIC</span><span class="p">,</span> <span class="n">params_overwrite</span><span class="o">=</span><span class="n">new_params</span>
<span class="p">)</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Now, movements are very slow:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>service<span class="w"> </span>call<span class="w"> </span>/leg1/shift<span class="w"> </span>motion_stack_msgs/srv/TFService<span class="w"> </span><span class="s2">&quot;{tf: {translation: {x: -100, y: 0, z: -100}, rotation: {x: 0.0, y: 0.0, z: 0.0, w: 1.0}}}&quot;</span>
</pre></div>
</div>
</section>
<section id="changing-end-effector-and-leg-numbers">
<h3>Changing end effector and leg numbers<a class="headerlink" href="#changing-end-effector-and-leg-numbers" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="n">LEGS_DIC</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;end2&quot;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;end1&quot;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;end3&quot;</span><span class="p">,</span>
    <span class="mi">40</span><span class="p">:</span> <span class="s2">&quot;end4&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Now, leg2 is the one at the front:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>service<span class="w"> </span>call<span class="w"> </span>/leg2/shift<span class="w"> </span>motion_stack_msgs/srv/TFService<span class="w"> </span><span class="s2">&quot;{tf: {translation: {x: -100, y: 0, z: -100}, rotation: {x: 0.0, y: 0.0, z: 0.0, w: 1.0}}}&quot;</span>
</pre></div>
</div>
<p>And leg 40 is the one on the right:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>service<span class="w"> </span>call<span class="w"> </span>/leg40/shift<span class="w"> </span>motion_stack_msgs/srv/TFService<span class="w"> </span><span class="s2">&quot;{tf: {translation: {x: 20, y: 50, z: -50}, rotation: {x: 0.0, y: 0.0, z: 0.0, w: 1.0}}}&quot;</span>
</pre></div>
</div>
<p>Revert this back when you are done, otherwise you might get confused
going further</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="n">LEGS_DIC</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;end1&quot;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;end2&quot;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;end3&quot;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;end4&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="o">...</span>
</pre></div>
</div>
</section>
<section id="overloading-to-have-a-single-robot-state-publisher">
<h3>Overloading to have a single robot_state_publisher<a class="headerlink" href="#overloading-to-have-a-single-robot-state-publisher" title="Link to this heading"></a></h3>
<p>Looking at the default launching behavior, you will see that each leg
has it own state publishers. This has limited usefulness for our Moobot
Zero because this robot makes use of one centralized computer and not
one computer per leg.</p>
<p>Let’s change the launcher to centralize the state publishers in global
namespace.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">class</span> <span class="nc">MyLevelBuilder</span><span class="p">(</span><span class="n">LevelBuilder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">state_publisher_lvl1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
        <span class="n">compiled_xacro</span> <span class="o">=</span> <span class="n">Command</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;xacro &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xacro_path</span><span class="p">])</span>
        <span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">leg_namespaces</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;leg</span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;leg_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvl1_params</span><span class="p">()]</span>
        <span class="n">all_joint_read_topics</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">/joint_read&quot;</span> <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">leg_namespaces</span><span class="p">]</span>
        <span class="n">node_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Node</span><span class="p">(</span>
                <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ms_package</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;joint_state_publisher&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;joint_state_publisher&quot;</span><span class="p">,</span>
                <span class="c1"># namespace=ns,</span>
                <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--ros-args&quot;</span><span class="p">,</span> <span class="s2">&quot;--log-level&quot;</span><span class="p">,</span> <span class="s2">&quot;warn&quot;</span><span class="p">],</span>
                <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;source_list&quot;</span><span class="p">:</span> <span class="n">all_joint_read_topics</span><span class="p">,</span>
                        <span class="s2">&quot;publish_default_positions&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="n">remappings</span><span class="o">=</span><span class="p">[</span>
                    <span class="c1"># (intside node, outside node),</span>
                    <span class="p">(</span><span class="s2">&quot;joint_states&quot;</span><span class="p">,</span> <span class="s2">&quot;continuous_joint_read&quot;</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">node_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Node</span><span class="p">(</span>
                <span class="n">package</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
                <span class="c1"># namespace=ns,</span>
                <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--ros-args&quot;</span><span class="p">,</span> <span class="s2">&quot;--log-level&quot;</span><span class="p">,</span> <span class="s2">&quot;warn&quot;</span><span class="p">],</span>
                <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;robot_description&quot;</span><span class="p">:</span> <span class="n">ParameterValue</span><span class="p">(</span>
                            <span class="n">compiled_xacro</span><span class="p">,</span> <span class="n">value_type</span><span class="o">=</span><span class="nb">str</span>
                        <span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="n">remappings</span><span class="o">=</span><span class="p">[</span>
                    <span class="c1"># (intside node, outside node),</span>
                    <span class="p">(</span><span class="s2">&quot;joint_states&quot;</span><span class="p">,</span> <span class="s2">&quot;continuous_joint_read&quot;</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">node_list</span>


<span class="o">...</span>
</pre></div>
</div>
<p>We created a new class <code class="docutils literal notranslate"><span class="pre">MyLevelBuilder</span></code> that inherits the behavior of
<code class="docutils literal notranslate"><span class="pre">LevelBuilder</span></code> and changes the one method <code class="docutils literal notranslate"><span class="pre">state_publisher_lvl1</span></code>.
Now, when <code class="docutils literal notranslate"><span class="pre">self.state_publisher_lvl1</span></code> is called, one
<code class="docutils literal notranslate"><span class="pre">joint_state_publisher</span></code> and <code class="docutils literal notranslate"><span class="pre">robot_state_publisher</span></code> is created in
the global namespace listening to the list of topics
<code class="docutils literal notranslate"><span class="pre">[leg1/joint_read,</span> <span class="pre">leg2/joint_read,</span> <span class="pre">...]</span></code>.</p>
</section>
<section id="remapping">
<h3>Remapping<a class="headerlink" href="#remapping" title="Link to this heading"></a></h3>
<p>Notice in the previous example, “joint_states” topic is used differently
by several nodes. They need to be remapped onto other name in the
launcher using the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="n">remappings</span><span class="o">=</span><span class="p">[</span>
        <span class="c1"># (intside node, outside node),</span>
        <span class="p">(</span><span class="s2">&quot;joint_states&quot;</span><span class="p">,</span> <span class="s2">&quot;continuous_joint_read&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="o">...</span>
</pre></div>
</div>
<p>This and namespaces are the main way to avoid conflicts when building
your modular system.</p>
</section>
<section id="automating-modularity">
<h3>Automating modularity<a class="headerlink" href="#automating-modularity" title="Link to this heading"></a></h3>
<p>Using python you can change the behavior of your launcher depending on
where it is launch (on the robot brain, on leg #1, on leg #2, on any PC,
on ground station, …). There is no one good way to do it, so I will
explain my method with a very basic example:</p>
<p>I define environment variables in the OS of the computer, then launch
different nodes base on that.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyLevelBuilder</span><span class="p">(</span><span class="n">LevelBuilder</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">robot_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">leg_dict</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="n">params_overwrite</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># gets the &quot;COMPUTER_ID&quot; environement variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COMPUTER_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COMPUTER_ID&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPUTER_ID</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;leg1&quot;</span><span class="p">,</span> <span class="s2">&quot;leg2&quot;</span><span class="p">,</span> <span class="s2">&quot;leg3&quot;</span><span class="p">,</span> <span class="s2">&quot;leg4&quot;</span><span class="p">]:</span>
            <span class="c1"># if running on one of the leg computer</span>
            <span class="c1"># we only start the assiciated leg/end-effector</span>
            <span class="n">leg_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COMPUTER_ID</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">end_effector</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">leg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">leg_number</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end_effector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;leg number has no entry in leg_dict&quot;</span><span class="p">)</span>
            <span class="n">reduced_leg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">leg_number</span><span class="p">:</span> <span class="n">end_effector</span><span class="p">}</span>
            <span class="n">leg_dict</span> <span class="o">=</span> <span class="n">reduced_leg_dict</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">robot_name</span><span class="p">,</span> <span class="n">leg_dict</span><span class="p">,</span> <span class="n">params_overwrite</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPUTER_ID</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;leg1&quot;</span><span class="p">,</span> <span class="s2">&quot;leg2&quot;</span><span class="p">,</span> <span class="s2">&quot;leg3&quot;</span><span class="p">,</span> <span class="s2">&quot;leg4&quot;</span><span class="p">]:</span>
            <span class="c1"># if running on one of the leg computer</span>
            <span class="c1"># we only start lvl1</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lvl1</span><span class="p">()]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPUTER_ID</span> <span class="o">==</span> <span class="s2">&quot;robot_brain&quot;</span><span class="p">:</span>
            <span class="c1"># if running on the main robot computer</span>
            <span class="c1"># we start lvl2-3-4</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lvl2</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvl3</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvl4</span><span class="p">()]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPUTER_ID</span> <span class="o">==</span> <span class="s2">&quot;ground_station&quot;</span><span class="p">:</span>
            <span class="c1"># if running on the ground station</span>
            <span class="c1"># we start only lvl5</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lvl5</span><span class="p">()]</span>
        <span class="c1"># if none of the previous cases, the default behavior runs all levels</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">make_levels</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="loading-you-own-node">
<h3>Loading you own node<a class="headerlink" href="#loading-you-own-node" title="Link to this heading"></a></h3>
<p>In the next section we will replace the default motion stack lvl1 node
with our own modified node, from our package. We will make the launcher
load our node instead of the default.</p>
<p>In the launcher replace:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">Node</span><span class="p">(</span>
    <span class="o">...</span>
    <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ms_package</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;joint_node&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;joint_node&quot;</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">Node</span><span class="p">(</span>
    <span class="o">...</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;moonbot_zero&quot;</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;lvl1&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;lvl1&quot;</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Now let’s edit our own lvl1 node</p>
</section>
</section>
<section id="changing-behavior">
<h2>Changing behavior<a class="headerlink" href="#changing-behavior" title="Link to this heading"></a></h2>
<p>The Motion Stack python code is design such that you can easily overload
relevant part of the code and use it like an API in which you inject
your code.</p>
<section id="overloading">
<h3>Overloading<a class="headerlink" href="#overloading" title="Link to this heading"></a></h3>
<p>After completing the previous step, modify
<code class="docutils literal notranslate"><span class="pre">src/moonbot_zero/moonbot_zero/lvl1.py</span></code>.</p>
<p>In this python file, import the joint_node of lvl1, make each joint move
in a sinusoidal motion, and send every command also on a string topic,
so you can listen to it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">easy_robot_control.EliaNode</span> <span class="kn">import</span> <span class="n">myMain</span><span class="p">,</span> <span class="n">rosTime2Float</span>
<span class="kn">from</span> <span class="nn">easy_robot_control.joint_state_interface</span> <span class="kn">import</span> <span class="n">JointNode</span>
<span class="kn">from</span> <span class="nn">easy_robot_control.utils.joint_state_util</span> <span class="kn">import</span> <span class="n">JState</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>


<span class="k">class</span> <span class="nc">ZeroLvl1</span><span class="p">(</span><span class="n">JointNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>  <span class="c1"># default node intialization</span>
        <span class="c1"># our new code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stringPUB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s2">&quot;display_angle_command&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinTMR</span><span class="p">:</span> <span class="n">Timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_sin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNow</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">joint_sin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Makes a sinusoidal motion on every joint&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNow</span><span class="p">()</span>
        <span class="n">since_start</span> <span class="o">=</span> <span class="n">rosTime2Float</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">amplitue</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">sinusoid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">since_start</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span> <span class="o">*</span> <span class="n">amplitue</span>
        <span class="n">state_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JState</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jointHandlerDic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">JState</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">sinusoid</span><span class="p">)</span>
            <span class="n">state_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coming_from_lvl2</span><span class="p">(</span><span class="n">state_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_to_lvl0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">JState</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function is executed every time data needs to be sent down.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">send_to_lvl0</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>  <span class="c1"># executes default</span>
        <span class="c1"># our new code</span>
        <span class="n">str_to_send</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">joint_state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">joint_state</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># skips empty states with no angles</span>
            <span class="n">str_to_send</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;lvl1 -&gt; lvl0: </span><span class="si">{</span><span class="n">joint_state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">joint_state</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">str_to_send</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stringPUB</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_to_send</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">myMain</span><span class="p">(</span><span class="n">ZeroLvl1</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>You can now listen to the motor commands of leg1 using:
<code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">topic</span> <span class="pre">echo</span> <span class="pre">/leg1/display_angle_command</span></code></p>
<p>Using overloading like this, you can easily add functionalities to the
motion stack without adding a new whole node and with minimal knowledge
of ros2. You can: - Change where the data is sent and how it is
formatted (like we did with the string topic). - Change where the data
comes from and its format (like we did with the timer, you can replace
it with a subscriber).</p>
<p>Are designed for overloading in lvl1:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">JointNode</span><span class="p">(</span><span class="n">EliaNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">send_to_lvl0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">JState</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sends states to lvl0 (commands for motors).</span>
<span class="sd">        This function is executed every time data needs to be sent down.</span>
<span class="sd">        Change/overload this method with what you need&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">send_to_lvl2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">JState</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sends states to lvl2 (states for ik).</span>
<span class="sd">        This function is executed every time data needs to be sent up.</span>
<span class="sd">        Change/overload this method with what you need&quot;&quot;&quot;</span>

    <span class="nd">@error_catcher</span>
    <span class="k">def</span> <span class="nf">js_from_lvl0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">JointState</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callbk when a JointState arrives from the lvl0 (states from motor).</span>
<span class="sd">        Converts it into a list of states, then hands it to the general function</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@error_catcher</span>
    <span class="k">def</span> <span class="nf">js_from_lvl2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">JointState</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callbk when a JointState arrives from the lvl2 (commands from ik).</span>
<span class="sd">        Converts it into a list of states, then hands it to the general function</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">coming_from_lvl2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JState</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Processes incomming commands from lvl2 ik.</span>
<span class="sd">        Call this function after processing the data to a List[JState].</span>
<span class="sd">        Always do super().coming_from_lvl0(states),</span>
<span class="sd">        Unless you know what you are doing&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">coming_from_lvl0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">JState</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Processes incomming sensor states from lvl0 motors.</span>
<span class="sd">        Call this function after processing the data to a List[JState].</span>
<span class="sd">        Always do super().coming_from_lvl0(states),</span>
<span class="sd">        Unless you know what you are doing&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="injection">
<h3>Injection<a class="headerlink" href="#injection" title="Link to this heading"></a></h3>
<p>Injection is adding an object that adds functionalities to the parent
object.</p>
<p>For now 3 injections are available: - Remappers: Remaps states names,
and applies shaping functions to the state data. - Topic publisher:
Publishes on individual Float64 topics instead of a JointStates topic. -
Offseter: Adds angle offsets to the output of lvl1 (and a little bit
more)</p>
<p>Let’s use all 3:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">easy_robot_control.EliaNode</span> <span class="kn">import</span> <span class="n">myMain</span><span class="p">,</span> <span class="n">rosTime2Float</span>
<span class="kn">from</span> <span class="nn">easy_robot_control.injection.offsetter</span> <span class="kn">import</span> <span class="n">OffsetterLvl0</span>
<span class="kn">from</span> <span class="nn">easy_robot_control.injection.topic_pub</span> <span class="kn">import</span> <span class="n">StatesToTopic</span>
<span class="kn">from</span> <span class="nn">easy_robot_control.joint_state_interface</span> <span class="kn">import</span> <span class="n">JointNode</span>
<span class="kn">from</span> <span class="nn">easy_robot_control.utils.joint_state_util</span> <span class="kn">import</span> <span class="n">JState</span>

<span class="kn">from</span> <span class="nn">easy_robot_control.utils.state_remaper</span> <span class="kn">import</span> <span class="n">Shaper</span><span class="p">,</span> <span class="n">StateMap</span><span class="p">,</span> <span class="n">StateRemapper</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>

<span class="n">remap_lvl1</span> <span class="o">=</span> <span class="n">StateRemapper</span><span class="p">(</span>
    <span class="n">name_map</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;joint2-1&quot;</span><span class="p">:</span> <span class="s2">&quot;my-new-joint&quot;</span><span class="p">},</span>
    <span class="n">state_map</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;joint2-1&quot;</span><span class="p">:</span> <span class="n">Shaper</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)},</span>
    <span class="n">unstate_map</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;joint2-1&quot;</span><span class="p">:</span> <span class="n">Shaper</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)},</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">ZeroLvl1</span><span class="p">(</span><span class="n">JointNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>  <span class="c1"># default node intialization</span>
        <span class="c1"># our new code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stringPUB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s2">&quot;display_angle_command&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinTMR</span><span class="p">:</span> <span class="n">Timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_sin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lvl0_remap</span> <span class="o">=</span> <span class="n">remap_lvl1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offsetter</span> <span class="o">=</span> <span class="n">OffsetterLvl0</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state2topic</span> <span class="o">=</span> <span class="n">StatesToTopic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># needs to be called in send_to_lvl0</span>

    <span class="k">def</span> <span class="nf">joint_sin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Makes a sinusoidal motion on every joint&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNow</span><span class="p">()</span>
        <span class="n">since_start</span> <span class="o">=</span> <span class="n">rosTime2Float</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">amplitue</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">sinusoid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">since_start</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span> <span class="o">*</span> <span class="n">amplitue</span>
        <span class="n">state_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JState</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jointHandlerDic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">JState</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">sinusoid</span><span class="p">)</span>
            <span class="n">state_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coming_from_lvl2</span><span class="p">(</span><span class="n">state_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_to_lvl0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">JState</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function is executed every time data needs to be sent down.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">send_to_lvl0</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>  <span class="c1"># executes default</span>
        <span class="c1"># our new code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state2topic</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="n">str_to_send</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;leg </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">leg_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">joint_state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">joint_state</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># skips empty states with no angles</span>
            <span class="n">str_to_send</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;lvl1 -&gt; lvl0: </span><span class="si">{</span><span class="n">joint_state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">joint_state</span><span class="o">.</span><span class="n">position</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">str_to_send</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stringPUB</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_to_send</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">myMain</span><span class="p">(</span><span class="n">ZeroLvl1</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Running <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">topic</span> <span class="pre">echo</span> <span class="pre">/leg1/display_angle_command</span></code> you’ll see that
<code class="docutils literal notranslate"><span class="pre">joint1-1</span></code> is now <code class="docutils literal notranslate"><span class="pre">my-new-joint</span></code>, and its value has been multiplied
by 2.</p>
<p>Running <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">topic</span> <span class="pre">list</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">.*/driver</span></code> you’ll see that topics have
been created to publish the positions of the joints.</p>
<p>Running the code below, will add 1 radian to the output of joint1-2 (not
in rviz, only on the motor command output).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>service<span class="w"> </span>call<span class="w"> </span>/leg1/set_offset<span class="w"> </span>motion_stack_msgs/srv/SendJointState<span class="w"> </span><span class="s2">&quot;{js: {name: [joint1-2], position: [1], velocity: [], effort: []}}&quot;</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="URDF_use.html" class="btn btn-neutral float-left" title="How to use your URDF with this repo" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="easy_robot_control.html" class="btn btn-neutral float-right" title="easy_robot_control package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Elian Nepple.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>